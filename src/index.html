<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Trade Journal — PnL Calendar</title>
  <link rel="stylesheet" href="css/styles.css" />
</head>
<body>
  <div class="wrap">

    <!-- Tabs -->
    <div class="card tabs">
      <button class="tabBtn active" id="tabJournalBtn" type="button">Journal</button>
      <button class="tabBtn" id="tabInsightsBtn" type="button">Insights</button>
      <div class="pill" style="margin-left:auto;">
        Storage: <strong>Local (this browser)</strong>
      </div>
    </div>

    <!-- ============================
         JOURNAL VIEW
         Calendar → Day Details → Entry
         ============================ -->
    <div class="view active" id="journalView">

      <!-- Calendar -->
      <div class="card calendarCard">
        <div class="calTop">
          <div style="display:flex; align-items:center; gap:10px; flex-wrap:wrap;">
            <div class="month" id="monthLabel">—</div>
            <div class="pill" title="Sum of PnL for all trades in the currently shown month">
              Month PnL: <strong id="monthTotalPnL">$0.00</strong>
            </div>
          </div>
          <div class="controls">
            <button id="prevMonthBtn" type="button">◀ Prev</button>
            <button id="todayBtn" type="button">Today</button>
            <button id="nextMonthBtn" type="button">Next ▶</button>
            <button id="clearDataBtn" type="button" title="Clears saved trades (local only)">Clear All Data</button>
          </div>
        </div>

        <div class="calGrid" id="calGrid"></div>

        <div class="warn" style="margin-top:12px;">
          Calendar tiles: <strong>day</strong> + <strong>no trades / n trades</strong> on top, and <strong>$PnL</strong> on bottom if trades exist.
        </div>
      </div>

      <!-- Day Details (hidden when selected day has no trades) -->
      <div class="card dayDetailsCard" id="dayDetailsCard">
        <div class="dayHeader">
          <div>
            <div class="hint" style="text-align:left; max-width:none; margin-bottom:6px;">
              Day details only appear when the selected day has trades.
            </div>
            <div class="date" id="dayDetailsDate">—</div>
          </div>
          <div class="pill">
            Trades: <strong id="dayTradeCount">0</strong> &nbsp;|&nbsp; <strong id="dayTotalPnL">$0.00</strong>
          </div>
        </div>

        <div class="dayDetailsGrid">
          <div>
            <h2 style="margin:0 0 10px 0; font-size:14px; color:var(--muted); text-transform:uppercase; letter-spacing:0.2px; font-weight:950;">
              Trades
            </h2>
            <div class="tradeList" id="tradeList"></div>
          </div>

          <div>
            <h2 style="margin:0 0 10px 0; font-size:14px; color:var(--muted); text-transform:uppercase; letter-spacing:0.2px; font-weight:950;">
              Selected trade
            </h2>
            <div class="detailBox" id="tradeDetailsBox">
              <div class="k">Select a trade to view details.</div>
            </div>

            <div class="inlineActions" id="tradeDetailActions" style="display:none;">
              <button class="warnBtn" id="editTradeBtn" type="button">Edit Trade</button>
              <button class="danger"  id="deleteTradeBtn" type="button">Delete Trade</button>
            </div>

            <div class="warn" style="margin-top:12px;">
              Tip: pick a trade on the left to view/edit/delete.
            </div>
          </div>
        </div>
      </div>

      <!-- Entry form -->
      <div class="card" id="entryCard">
        <div class="title">
          <h1>Trade Journal — Entry</h1>
          <div class="hint">
            Click a day on the calendar to set the trade date.<br/>
            Enter trade details below and submit to the selected day.
          </div>
        </div>

        <div class="grid tight3">
          <div class="field">
            <label>Selected day</label>
            <div class="pill">
              <span>Date:</span> <strong id="selectedDayText">—</strong>
            </div>
            <div class="warn" style="margin-top:10px;">
              <strong>Required:</strong> choose a calendar day before submitting.
            </div>
          </div>

          <div class="field">
            <label for="tickerSelect">Ticker</label>
            <select id="tickerSelect">
              <option value="" selected disabled>Select ticker…</option>
              <option value="NQ">NQ</option>
              <option value="MNQ">MNQ</option>
              <option value="ES">ES</option>
              <option value="MES">MES</option>
              <option value="MGC">MGC</option>
            </select>
          </div>

          <div class="field">
            <label>Time of day</label>
            <div class="row3">
              <select id="hourSelect"   aria-label="Hour"><option value="" selected disabled>Hour</option></select>
              <select id="minuteSelect" aria-label="Minute"><option value="" selected disabled>Min</option></select>
              <select id="ampmSelect"   aria-label="AM or PM">
                <option value="AM">AM</option>
                <option value="PM">PM</option>
              </select>
            </div>
            <div class="warn" id="timePreview" style="margin-top:10px;">Selected time: —</div>
          </div>
        </div>

        <div class="grid">
          <div class="field">
            <label>Trade details</label>
            <div class="row3">
              <select id="dirSelect" aria-label="Direction">
                <option value="" selected disabled>Long/Short</option>
                <option value="Long">Long</option>
                <option value="Short">Short</option>
              </select>
              <input id="rrInput"  type="number" step="0.1"    placeholder="Target RR (e.g., 2.0)" />
              <input id="pnlInput" type="number" step="0.01"   placeholder="PnL (e.g., 125.50 or -80)" />
            </div>
            <div class="warn" style="margin-top:10px;">Day color uses net PnL (green/red) once at least 1 trade exists.</div>
          </div>

          <div class="field">
            <label for="notesInput">Notes</label>
            <textarea id="notesInput" placeholder="Only visible when you open the submitted trade."></textarea>
          </div>
        </div>

        <div class="field" style="margin-bottom:14px;">
          <div class="search">
            <label for="confluenceInput">Add confluences</label>
            <input id="confluenceInput" type="text" autocomplete="off"
                   placeholder="Start typing (e.g., Bullish 1hr FVG, Bearish 5min IFVG)..." />
            <div id="dropdown" class="dropdown" role="listbox" aria-label="Confluence suggestions"></div>
          </div>
          <div class="chips" id="chips" aria-label="Selected confluences"></div>
        </div>

        <div class="recap">
          <h2>Trade recap (preview)</h2>
          <div class="text" id="previewText" aria-live="polite"></div>
        </div>

        <div class="actions" id="entryActions">
          <button class="primary" id="submitBtn">Submit Trade</button>
          <button class="ghost"   id="clearBtn">Clear Entry</button>
        </div>

        <div class="actions" id="editActions" style="display:none;">
          <button class="warnBtn" id="saveEditBtn">Save Changes</button>
          <button class="ghost"   id="cancelEditBtn">Cancel Edit</button>
        </div>

        <div class="warn" id="modeHint">
          <strong>Submit rules:</strong> must select a calendar day and at least 1 confluence.
        </div>
      </div>
    </div>

    <!-- ============================
         INSIGHTS VIEW
         ============================ -->
    <div class="view" id="insightsView">
      <div class="card">
        <div class="title" style="margin-bottom:8px;">
          <h1>Insights</h1>
          <div class="hint">
            Uses your saved trades in this browser (localStorage).<br/>
            Win = <b>PnL &gt; 0</b> • Loss = <b>PnL &lt; 0</b> • Breakeven = <b>PnL = 0</b>
          </div>
        </div>
        <div class="actions" style="margin-top:0;">
          <button class="ghost" id="refreshInsightsBtn" type="button">Refresh Insights</button>
        </div>
        <div class="warn" style="margin-top:10px;">
          Tip: Insights update automatically when you add/edit/delete trades, but you can also refresh manually.
        </div>
      </div>

      <div class="insightsWrap">
        <div class="card">
          <h2 style="margin:0 0 10px 0; font-size:14px; color:var(--muted); text-transform:uppercase; letter-spacing:0.2px; font-weight:950;">
            Key stats
          </h2>
          <div class="statGrid">
            <div class="stat"><div class="k">Win percentage</div>     <div class="v" id="statWinPct">—</div>        <div class="s" id="statWinPctSub">—</div></div>
            <div class="stat"><div class="k">Total trades</div>        <div class="v" id="statTotalTrades">—</div>   <div class="s" id="statTotalTradesSub">—</div></div>
            <div class="stat"><div class="k">Best winning day</div>    <div class="v" id="statBestDay">—</div>       <div class="s" id="statBestDaySub">—</div></div>
            <div class="stat"><div class="k">Worst losing day</div>    <div class="v" id="statWorstDay">—</div>      <div class="s" id="statWorstDaySub">—</div></div>
            <div class="stat"><div class="k">Best trade</div>          <div class="v" id="statBestTrade">—</div>     <div class="s" id="statBestTradeSub">—</div></div>
            <div class="stat"><div class="k">Worst trade</div>         <div class="v" id="statWorstTrade">—</div>    <div class="s" id="statWorstTradeSub">—</div></div>
            <div class="stat"><div class="k">Best confluence win rate</div>  <div class="v" id="statBestConf">—</div>  <div class="s" id="statBestConfSub">—</div></div>
            <div class="stat"><div class="k">Worst confluence win rate</div> <div class="v" id="statWorstConf">—</div> <div class="s" id="statWorstConfSub">—</div></div>
            <div class="stat"><div class="k">Best setup win rate</div> <div class="v" id="statBestSetup">—</div>    <div class="s" id="statBestSetupSub">—</div></div>
            <div class="stat"><div class="k">Best time of day</div>    <div class="v" id="statBestTime">—</div>      <div class="s" id="statBestTimeSub">—</div></div>
            <div class="stat"><div class="k">Win rate: Long</div>      <div class="v" id="statLongWin">—</div>       <div class="s" id="statLongWinSub">—</div></div>
            <div class="stat"><div class="k">Win rate: Short</div>     <div class="v" id="statShortWin">—</div>      <div class="s" id="statShortWinSub">—</div></div>
          </div>
          <div class="warn" style="margin-top:10px;">
            Notes: "Best confluence" and "Best setup" require enough samples to mean anything. Small sample sizes can lie.
          </div>
        </div>

        <div class="card">
          <h2 style="margin:0 0 10px 0; font-size:14px; color:var(--muted); text-transform:uppercase; letter-spacing:0.2px; font-weight:950;">
            Win rate per confluence
          </h2>
          <div class="table" id="confTable">
            <div class="trow"><div>Confluence</div><div class="badgeMini">Win%</div></div>
          </div>
          <div class="warn" style="margin-top:12px;">
            Sorted by win rate (desc). Shows only confluences that appear in at least 1 trade.
          </div>
        </div>

        <div class="card" style="grid-column: 1 / -1;">
          <h2 style="margin:0 0 10px 0; font-size:14px; color:var(--muted); text-transform:uppercase; letter-spacing:0.2px; font-weight:950;">
            Setup win rate (confluences together)
          </h2>
          <div class="table" id="setupTable">
            <div class="trow"><div>Setup (sorted confluences)</div><div class="badgeMini">Win%</div></div>
          </div>
          <div class="warn" style="margin-top:12px;">
            "Setup" = the exact combination of confluences on a trade (order doesn't matter). Sorted by win rate (desc),
            then by sample size. Shows top 12.
          </div>
        </div>

        <div class="card" style="grid-column: 1 / -1;">
          <h2 style="margin:0 0 10px 0; font-size:14px; color:var(--muted); text-transform:uppercase; letter-spacing:0.2px; font-weight:950;">
            Best time of day (by hour)
          </h2>
          <div class="table" id="timeTable">
            <div class="trow"><div>Hour bucket</div><div class="badgeMini">Win%</div></div>
          </div>
          <div class="warn" style="margin-top:12px;">
            Bucket = hour of day in your saved trade time. If a trade has no time set, it's ignored for this section.
          </div>
        </div>
      </div>
    </div>

  </div>

  <!-- Scripts: data → utilities → modules → app (order matters) -->
  <script src="data/confluences.js"></script>
  <script src="js/utils.js"></script>
  <script src="js/storage.js"></script>
  <script src="js/calendar.js"></script>
  <script src="js/insights.js"></script>
  <script src="js/app.js"></script>
</body>
</html>
